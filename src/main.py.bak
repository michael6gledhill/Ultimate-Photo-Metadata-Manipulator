"""
Main GUI Application for Photo Metadata Manipulator
Built with wxPython
"""

import wx
import wx.lib.scrolledpanel as scrolled
import json
import os
from pathlib import Path
from typing import Optional, Dict, Any

from metadata_handler import MetadataHandler
from templates import TemplateManager
from typing import List


class MainFrame(wx.Frame):
    """Main application window."""

    def __init__(self):
        super().__init__(None, title="Photo Metadata Manipulator", size=(1000, 700))

        self.metadata_handler = MetadataHandler()
        self.template_manager = TemplateManager()
        self.current_file = None
        self.current_metadata = {}

        self.init_ui()
        self.Centre()
        self.Show()

    def init_ui(self):
        """Initialize the UI with main panels."""
        main_panel = wx.Panel(self)
        main_sizer = wx.BoxSizer(wx.VERTICAL)

        # Menu Bar
        self.create_menu_bar()

        # Toolbar
        toolbar = self.create_toolbar(main_panel)
        main_sizer.Add(toolbar, 0, wx.EXPAND)

        # Main content area (splitter for file tree and metadata view)
        splitter = wx.SplitterWindow(main_panel)
        left_panel = self.create_file_panel(splitter)
        right_panel = self.create_metadata_panel(splitter)

        splitter.SplitVertically(left_panel, right_panel)
        splitter.SetSashPosition(300)

        main_sizer.Add(splitter, 1, wx.EXPAND)

        # Status bar
        self.CreateStatusBar()
        self.SetStatusText("Ready")

        main_panel.SetSizer(main_sizer)

    def create_menu_bar(self):
        """Create the menu bar."""
        menu_bar = wx.MenuBar()

        # File menu
        file_menu = wx.Menu()
        file_menu.Append(wx.ID_OPEN, "Open Image\tCtrl+O")
        file_menu.Append(wx.ID_SAVE, "Save Metadata\tCtrl+S")
        file_menu.AppendSeparator()
        file_menu.Append(wx.ID_EXIT, "Exit\tCtrl+Q")

        # Metadata menu
        metadata_menu = wx.Menu()
        metadata_menu.Append(wx.ID_ANY, "View All Metadata\tCtrl+M")
        edit_item = metadata_menu.Append(wx.ID_ANY, "Edit Metadata\tCtrl+E")
        metadata_menu.Append(wx.ID_ANY, "Clear All Metadata")
        metadata_menu.AppendSeparator()
        export_json_item = metadata_menu.Append(wx.ID_ANY, "Export as JSON")
        export_txt_item = metadata_menu.Append(wx.ID_ANY, "Export as TXT")

        # Templates menu
        templates_menu = wx.Menu()
        templates_menu.Append(wx.ID_ANY, "Create Template")
        templates_menu.Append(wx.ID_ANY, "Manage Templates")
        templates_menu.AppendSeparator()
        templates_menu.Append(wx.ID_ANY, "Import Templates")
        templates_menu.Append(wx.ID_ANY, "Export Templates")

        # Help menu
        help_menu = wx.Menu()
        help_menu.Append(wx.ID_ABOUT, "About")

        menu_bar.Append(file_menu, "&File")
        menu_bar.Append(metadata_menu, "&Metadata")
        menu_bar.Append(templates_menu, "&Templates")
        menu_bar.Append(help_menu, "&Help")

        self.SetMenuBar(menu_bar)

        # Bind events
        self.Bind(wx.EVT_MENU, self.on_open_image, id=wx.ID_OPEN)
        # bind edit metadata
        self.Bind(wx.EVT_MENU, self.on_edit_metadata, id=edit_item.GetId())
        # bind export handlers
        self.Bind(wx.EVT_MENU, self.on_export_metadata_json, id=export_json_item.GetId())
        self.Bind(wx.EVT_MENU, self.on_export_metadata_txt, id=export_txt_item.GetId())
        self.Bind(wx.EVT_MENU, self.on_exit, id=wx.ID_EXIT)

    def create_toolbar(self, parent) -> wx.Panel:
        """Create toolbar with action buttons. `parent` should be the main panel."""
        toolbar_panel = wx.Panel(parent)
        sizer = wx.BoxSizer(wx.HORIZONTAL)

        btn_open = wx.Button(toolbar_panel, label="Open Image")
        btn_view = wx.Button(toolbar_panel, label="View Metadata")
        btn_clear = wx.Button(toolbar_panel, label="Clear All")
        btn_templates = wx.Button(toolbar_panel, label="Templates")

        sizer.Add(btn_open, 0, wx.ALL, 5)
        sizer.Add(btn_view, 0, wx.ALL, 5)
        sizer.Add(btn_clear, 0, wx.ALL, 5)
        sizer.Add(btn_templates, 0, wx.ALL, 5)

        toolbar_panel.SetSizer(sizer)

        btn_open.Bind(wx.EVT_BUTTON, self.on_open_image)
        btn_view.Bind(wx.EVT_BUTTON, self.on_view_metadata)
        btn_clear.Bind(wx.EVT_BUTTON, self.on_clear_metadata)
        btn_templates.Bind(wx.EVT_BUTTON, self.on_templates)

        btn_rename = wx.Button(toolbar_panel, label="Batch Rename")
        sizer.Add(btn_rename, 0, wx.ALL, 5)
        btn_rename.Bind(wx.EVT_BUTTON, self.on_batch_rename)

        return toolbar_panel

    def create_file_panel(self, parent) -> wx.Panel:
        """Create file browser panel. `parent` should be the splitter window."""
        panel = wx.Panel(parent)
        sizer = wx.BoxSizer(wx.VERTICAL)

        label = wx.StaticText(panel, label="File Browser")
        font = label.GetFont()
        font.PointSize += 2
        font = font.Bold()
        label.SetFont(font)

        self.file_list = wx.ListBox(panel)
        self.file_list.Bind(wx.EVT_LISTBOX, self.on_file_selected)

        # Enable drag-and-drop of files into the file list
        class FileDropTarget(wx.FileDropTarget):
            def __init__(self, target_widget, frame):
                super().__init__()
                self.target = target_widget
                self.frame = frame

            def OnDropFiles(self, x, y, filenames: List[str]) -> bool:
                # Filter supported files and add to list
                added = 0
                for f in filenames:
                    if self.frame.metadata_handler.is_supported(f):
                        # Avoid duplicates
                        if isinstance(self.target, wx.ListBox):
                            if self.target.FindString(f) == wx.NOT_FOUND:
                                self.target.Append(f)
                                added += 1
                        else:
                            # Generic behavior: append text representation
                            try:
                                self.target.AppendItem(self.target.GetRootItem(), f)
                            except Exception:
                                pass

                # If at least one supported file was dropped, select the first and show metadata
                if added > 0:
                    # select the last appended file (most recent)
                    try:
                        idx = self.target.GetCount() - 1
                        if idx >= 0:
                            self.target.SetSelection(idx)
                            self.frame.current_file = self.target.GetString(idx)
                            self.frame.on_view_metadata(None)
                    except Exception:
                        pass
                return True

        self.file_list.SetDropTarget(FileDropTarget(self.file_list, self))

        sizer.Add(label, 0, wx.ALL, 5)
        sizer.Add(self.file_list, 1, wx.EXPAND | wx.ALL, 5)

        panel.SetSizer(sizer)
        return panel

    def create_metadata_panel(self, parent) -> wx.Panel:
        """Create metadata display and editor panel. `parent` should be the splitter window."""
        panel = wx.Panel(parent)
        sizer = wx.BoxSizer(wx.VERTICAL)

        label = wx.StaticText(panel, label="Metadata")
        font = label.GetFont()
        font.PointSize += 2
        font = font.Bold()
        label.SetFont(font)

        # Metadata tree view
        self.metadata_tree = wx.TreeCtrl(panel)
        root = self.metadata_tree.AddRoot("Image Metadata")

        sizer.Add(label, 0, wx.ALL, 5)
        sizer.Add(self.metadata_tree, 1, wx.EXPAND | wx.ALL, 5)

        panel.SetSizer(sizer)
        return panel

    def on_open_image(self, event):
        """Open an image file."""
        wildcard = "Image files (*.jpg;*.jpeg;*.png;*.tiff;*.tif;*.gif;*.bmp)|*.jpg;*.jpeg;*.png;*.tiff;*.tif;*.gif;*.bmp|All files (*.*)|*.*"
        dlg = wx.FileDialog(self, "Open Image", wildcard=wildcard, style=wx.FD_OPEN | wx.FD_FILE_MUST_EXIST)

        if dlg.ShowModal() == wx.ID_OK:
            self.current_file = dlg.GetPath()
            self.SetTitle(f"Photo Metadata Manipulator - {Path(self.current_file).name}")
            self.SetStatusText(f"Loaded: {self.current_file}")
            self.on_view_metadata(None)

        dlg.Destroy()

    def on_file_selected(self, event):
        """Handle file selection from list."""
        selection = self.file_list.GetSelection()
        if selection != wx.NOT_FOUND:
            self.current_file = self.file_list.GetString(selection)
            self.on_view_metadata(None)

    def on_view_metadata(self, event):
        """Display metadata for the current file."""
        if not self.current_file or not os.path.exists(self.current_file):
            wx.MessageBox("Please open an image file first.", "No File", wx.OK | wx.ICON_WARNING)
            return

        # Read metadata
        self.current_metadata = self.metadata_handler.read_metadata(self.current_file)

        if not self.current_metadata:
            wx.MessageBox(self.metadata_handler.last_error or "Could not read metadata.", "Error", wx.OK | wx.ICON_ERROR)
            return

        # Populate tree view
        self.metadata_tree.DeleteAllItems()
        root = self.metadata_tree.AddRoot("Image Metadata")

        for section, data in self.current_metadata.items():
            if data:
                section_node = self.metadata_tree.AppendItem(root, section.upper())
                if isinstance(data, dict):
                    for key, value in data.items():
                        self.metadata_tree.AppendItem(section_node, f"{key}: {value}")

        self.metadata_tree.ExpandAll()
        self.SetStatusText(f"Metadata loaded: {len(self.current_metadata)} sections")

    def on_export_metadata_json(self, event):
        """Export current file metadata as JSON to a user-selected file."""
        if not self.current_file or not os.path.exists(self.current_file):
            wx.MessageBox("Please open an image file first.", "No File", wx.OK | wx.ICON_WARNING)
            return

        metadata = self.current_metadata or self.metadata_handler.read_metadata(self.current_file)
        if not metadata:
            wx.MessageBox(self.metadata_handler.last_error or "Could not read metadata.", "Error", wx.OK | wx.ICON_ERROR)
            return

        dlg = wx.FileDialog(self, "Save metadata as JSON",
                             defaultDir=os.path.dirname(self.current_file),
                             defaultFile=f"{Path(self.current_file).stem}_metadata.json",
                             wildcard="JSON files (*.json)|*.json",
                             style=wx.FD_SAVE | wx.FD_OVERWRITE_PROMPT)
        if dlg.ShowModal() == wx.ID_OK:
            path = dlg.GetPath()
            try:
                with open(path, 'w', encoding='utf-8') as fh:
                    json.dump(metadata, fh, indent=2, ensure_ascii=False, default=str)
                wx.MessageBox(f"Metadata exported to:\n{path}", "Exported", wx.OK | wx.ICON_INFORMATION)
            except Exception as e:
                wx.MessageBox(f"Failed to write metadata: {e}", "Error", wx.OK | wx.ICON_ERROR)
        dlg.Destroy()

    def on_export_metadata_txt(self, event):
        """Export current file metadata as plain text (JSON pretty print) to a user-selected file."""
        if not self.current_file or not os.path.exists(self.current_file):
            wx.MessageBox("Please open an image file first.", "No File", wx.OK | wx.ICON_WARNING)
            return

        metadata = self.current_metadata or self.metadata_handler.read_metadata(self.current_file)
        if not metadata:
            wx.MessageBox(self.metadata_handler.last_error or "Could not read metadata.", "Error", wx.OK | wx.ICON_ERROR)
            return

        dlg = wx.FileDialog(self, "Save metadata as TXT",
                             defaultDir=os.path.dirname(self.current_file),
                             defaultFile=f"{Path(self.current_file).stem}_metadata.txt",
                             wildcard="Text files (*.txt)|*.txt|All files (*.*)|*.*",
                             style=wx.FD_SAVE | wx.FD_OVERWRITE_PROMPT)
        if dlg.ShowModal() == wx.ID_OK:
            path = dlg.GetPath()
            try:
                with open(path, 'w', encoding='utf-8') as fh:
                    fh.write(json.dumps(metadata, indent=2, ensure_ascii=False, default=str))
                wx.MessageBox(f"Metadata exported to:\n{path}", "Exported", wx.OK | wx.ICON_INFORMATION)
            except Exception as e:
                wx.MessageBox(f"Failed to write metadata: {e}", "Error", wx.OK | wx.ICON_ERROR)
        dlg.Destroy()

    def on_edit_metadata(self, event):
        """Open editor dialog to modify common metadata fields."""
        if not self.current_file:
            wx.MessageBox("Please open an image file first.", "No File", wx.OK | wx.ICON_WARNING)
            return

        dlg = EditMetadataDialog(self, self.current_file, self.metadata_handler)
        if dlg.ShowModal() == wx.ID_OK:
            # Refresh metadata
            self.on_view_metadata(None)
        dlg.Destroy()

    def on_batch_rename(self, event):
        dlg = BatchRenameDialog(self)
        if dlg.ShowModal() == wx.ID_OK:
            files, pattern, start, padding, case = dlg.get_values()
            if not files:
                wx.MessageBox("No files selected.", "Batch Rename", wx.OK | wx.ICON_WARNING)
            else:
                renamed = []
                for idx, f in enumerate(files, start=start):
                    p = Path(f)
                    index_str = str(idx).zfill(padding)
                    new_base = pattern.replace('{index}', index_str)
                    if case == 'lower':
                        new_base = new_base.lower()
                    elif case == 'upper':
                        new_base = new_base.upper()
                    elif case == 'title':
                        new_base = new_base.title()

                    new_path = p.with_name(f"{new_base}{p.suffix}")
                    try:
                        p.rename(new_path)
                        renamed.append(str(new_path))
                    except Exception as e:
                        wx.MessageBox(f"Failed to rename {p} -> {new_path}: {e}", "Error", wx.OK | wx.ICON_ERROR)

                wx.MessageBox(f"Renamed {len(renamed)} files.", "Batch Rename", wx.OK | wx.ICON_INFORMATION)
        dlg.Destroy()

    def on_clear_metadata(self, event):
        """Clear all metadata from current image."""
        if not self.current_file:
            wx.MessageBox("Please open an image file first.", "No File", wx.OK | wx.ICON_WARNING)
            return

        dlg = wx.MessageDialog(self, 
                               "Are you sure you want to remove all metadata?\nThis action cannot be undone.",
                               "Clear All Metadata", 
                               wx.YES_NO | wx.ICON_WARNING)

        if dlg.ShowModal() == wx.ID_YES:
            output_path = None
            # Optionally ask for output path
            save_dlg = wx.FileDialog(self, "Save cleaned image as...", 
                                     defaultDir=os.path.dirname(self.current_file),
                                     defaultFile=f"clean_{Path(self.current_file).name}",
                                     wildcard="JPEG (*.jpg)|*.jpg|PNG (*.png)|*.png",
                                     style=wx.FD_SAVE | wx.FD_OVERWRITE_PROMPT)
            if save_dlg.ShowModal() == wx.ID_OK:
                output_path = save_dlg.GetPath()

            if self.metadata_handler.delete_all_metadata(self.current_file, output_path):
                wx.MessageBox(f"Metadata cleared successfully!\nSaved to: {output_path or self.current_file}", 
                             "Success", wx.OK | wx.ICON_INFORMATION)
                self.on_view_metadata(None)
            else:
                wx.MessageBox(self.metadata_handler.last_error or "Error clearing metadata.", 
                             "Error", wx.OK | wx.ICON_ERROR)
            save_dlg.Destroy()

        dlg.Destroy()

    def on_templates(self, event):
        """Open template manager."""
        dlg = TemplateDialog(self, self.template_manager)
        dlg.ShowModal()
        dlg.Destroy()

    def on_exit(self, event):
        """Exit the application."""
        self.Close(True)


class EditMetadataDialog(wx.Dialog):
    """Dialog to edit common metadata fields."""

    def __init__(self, parent, file_path, metadata_handler):
        super().__init__(parent, title="Edit Metadata", size=(450, 380))
        self.file_path = file_path
        self.handler = metadata_handler
        self.init_ui()

    def init_ui(self):
        sizer = wx.BoxSizer(wx.VERTICAL)

        metadata = self.handler.read_metadata(self.file_path) or {}
        exif = metadata.get('exif', {}) or {}
        xmp = metadata.get('xmp', {}) or {}

        # Helper to pick a value from xmp or exif
        def pick(keys):
            for k in keys:
                if k in xmp and xmp[k]:
                    return xmp[k]
                if k in exif and exif[k]:
                    return exif[k]
            return ''

        title_val = pick(['dc:title', 'Title', 'ImageDescription'])
        subject_val = pick(['dc:subject', 'Subject'])
        tags_val = pick(['dc:subject'])
        comments_val = pick(['dc:description', 'UserComment'])
        authors_val = pick(['dc:creator', 'Artist'])
        copyright_val = pick(['dc:rights', 'Copyright'])

        # Fields
        self.tc_title = wx.TextCtrl(self, value=str(title_val))
        self.tc_subject = wx.TextCtrl(self, value=str(subject_val))
        self.tc_tags = wx.TextCtrl(self, value=(','.join(tags_val) if isinstance(tags_val, list) else str(tags_val)))
        self.tc_comments = wx.TextCtrl(self, value=str(comments_val))
        self.tc_authors = wx.TextCtrl(self, value=str(authors_val))
        self.tc_copyright = wx.TextCtrl(self, value=str(copyright_val))

        grid = wx.FlexGridSizer(6, 2, 8, 8)
        grid.AddGrowableCol(1, 1)
        grid.Add(wx.StaticText(self, label="Title:"), 0, wx.ALIGN_CENTER_VERTICAL)
        grid.Add(self.tc_title, 1, wx.EXPAND)
        grid.Add(wx.StaticText(self, label="Subject:"), 0, wx.ALIGN_CENTER_VERTICAL)
        grid.Add(self.tc_subject, 1, wx.EXPAND)
        grid.Add(wx.StaticText(self, label="Tags (comma-separated):"), 0, wx.ALIGN_CENTER_VERTICAL)
        grid.Add(self.tc_tags, 1, wx.EXPAND)
        grid.Add(wx.StaticText(self, label="Comments:"), 0, wx.ALIGN_CENTER_VERTICAL)
        grid.Add(self.tc_comments, 1, wx.EXPAND)
        grid.Add(wx.StaticText(self, label="Authors (semicolon-separated):"), 0, wx.ALIGN_CENTER_VERTICAL)
        grid.Add(self.tc_authors, 1, wx.EXPAND)
        grid.Add(wx.StaticText(self, label="Copyright:"), 0, wx.ALIGN_CENTER_VERTICAL)
        grid.Add(self.tc_copyright, 1, wx.EXPAND)

        sizer.Add(grid, 1, wx.ALL | wx.EXPAND, 12)

        btn_sizer = wx.StdDialogButtonSizer()
        ok = wx.Button(self, wx.ID_OK)
        cancel = wx.Button(self, wx.ID_CANCEL)
        btn_sizer.AddButton(ok)
        btn_sizer.AddButton(cancel)
        btn_sizer.Realize()

        sizer.Add(btn_sizer, 0, wx.ALIGN_RIGHT | wx.ALL, 8)
        self.SetSizer(sizer)

    def EndModal(self, retCode=wx.ID_OK):
        # On OK, collect values and write metadata
        if retCode == wx.ID_OK:
            updates = {
                'title': self.tc_title.GetValue().strip(),
                'subject': self.tc_subject.GetValue().strip(),
                'tags': [t.strip() for t in self.tc_tags.GetValue().split(',') if t.strip()],
                'comments': self.tc_comments.GetValue().strip(),
                'authors': self.tc_authors.GetValue().strip(),
                'copyright': self.tc_copyright.GetValue().strip()
            }
            ok = self.handler.edit_metadata(self.file_path, updates, None)
            if not ok:
                wx.MessageBox(self.handler.last_error or "Failed to write metadata.", "Error", wx.OK | wx.ICON_ERROR)
        return super().EndModal(retCode)


class BatchRenameDialog(wx.Dialog):
    """Dialog to batch rename files using a pattern with {index}."""

    def __init__(self, parent):
        super().__init__(parent, title="Batch Rename", size=(520, 240))
        self.selected_files = []
        self.init_ui()

    def init_ui(self):
        sizer = wx.BoxSizer(wx.VERTICAL)

        # File chooser
        h = wx.BoxSizer(wx.HORIZONTAL)
        self.tc_files = wx.TextCtrl(self, style=wx.TE_READONLY)
        btn_choose = wx.Button(self, label="Choose Files")
        h.Add(self.tc_files, 1, wx.EXPAND | wx.ALL, 6)
        h.Add(btn_choose, 0, wx.ALL, 6)
        sizer.Add(h, 0, wx.EXPAND)

        # Pattern and options
        grid = wx.FlexGridSizer(3, 2, 8, 8)
        grid.Add(wx.StaticText(self, label="Pattern (use {index}):"), 0, wx.ALIGN_CENTER_VERTICAL)
        self.tc_pattern = wx.TextCtrl(self, value="test_{index}")
        grid.Add(self.tc_pattern, 1, wx.EXPAND)
        grid.Add(wx.StaticText(self, label="Start index:"), 0, wx.ALIGN_CENTER_VERTICAL)
        self.spin_start = wx.SpinCtrl(self, value="1", min=0, max=1000000)
        grid.Add(self.spin_start, 0, wx.EXPAND)
        grid.Add(wx.StaticText(self, label="Zero-pad width:"), 0, wx.ALIGN_CENTER_VERTICAL)
        self.spin_pad = wx.SpinCtrl(self, value="0", min=0, max=10)
        grid.Add(self.spin_pad, 0, wx.EXPAND)

        sizer.Add(grid, 0, wx.ALL | wx.EXPAND, 8)

        # Case choice
        case_h = wx.BoxSizer(wx.HORIZONTAL)
        case_h.Add(wx.StaticText(self, label="Case:"), 0, wx.ALIGN_CENTER_VERTICAL | wx.ALL, 6)
        self.choice_case = wx.Choice(self, choices=["as-is", "lower", "upper", "title"]) 
        self.choice_case.SetSelection(0)
        case_h.Add(self.choice_case, 0, wx.ALL, 6)
        sizer.Add(case_h, 0, wx.LEFT)

        # Preview of first 3 renamed files
        sizer.Add(wx.StaticText(self, label="Preview (first 3):"), 0, wx.LEFT | wx.TOP, 6)
        self.tc_preview = wx.TextCtrl(self, style=wx.TE_MULTILINE | wx.TE_READONLY, size=(-1, 80))
        sizer.Add(self.tc_preview, 0, wx.EXPAND | wx.ALL, 8)

        # Bind events to update preview when options change
        self.tc_pattern.Bind(wx.EVT_TEXT, lambda e: self.update_preview())
        self.spin_start.Bind(wx.EVT_SPINCTRL, lambda e: self.update_preview())
        self.spin_pad.Bind(wx.EVT_SPINCTRL, lambda e: self.update_preview())
        self.choice_case.Bind(wx.EVT_CHOICE, lambda e: self.update_preview())

        btn_sizer = wx.StdDialogButtonSizer()
        ok_button = wx.Button(self, wx.ID_OK)
        cancel_button = wx.Button(self, wx.ID_CANCEL)
        btn_sizer.AddButton(ok_button)
        btn_sizer.AddButton(cancel_button)
        btn_sizer.Realize()

        sizer.Add(btn_sizer, 0, wx.ALIGN_RIGHT | wx.ALL, 8)

        self.SetSizer(sizer)

        btn_choose.Bind(wx.EVT_BUTTON, self.on_choose_files)
        # initial preview
        self.update_preview()

    def on_choose_files(self, event):
        dlg = wx.FileDialog(self, "Select files to rename", style=wx.FD_MULTIPLE | wx.FD_FILE_MUST_EXIST)
        if dlg.ShowModal() == wx.ID_OK:
            self.selected_files = dlg.GetPaths()
            self.tc_files.SetValue(', '.join(self.selected_files))
        dlg.Destroy()

    def get_values(self):
        return (self.selected_files, self.tc_pattern.GetValue(), int(self.spin_start.GetValue()), int(self.spin_pad.GetValue()), self.choice_case.GetString(self.choice_case.GetSelection()))

    def update_preview(self):
        """Update the preview box showing the first three target names."""
        pattern = self.tc_pattern.GetValue()
        try:
            start = int(self.spin_start.GetValue())
        except Exception:
            start = 1
        try:
            pad = int(self.spin_pad.GetValue())
        except Exception:
            pad = 0
        case = self.choice_case.GetString(self.choice_case.GetSelection())

        # determine indices to preview: based on selected files if present, else 1..3
        indices = []
        if self.selected_files:
            # preview first three indices relative to provided list start
            for i in range(min(3, len(self.selected_files))):
                indices.append(start + i)
        else:
            indices = [start + i for i in range(3)]

        lines = []
        for idx in indices:
            index_str = str(idx).zfill(pad)
            new_base = pattern.replace('{index}', index_str)
            if case == 'lower':
                new_base = new_base.lower()
            elif case == 'upper':
                new_base = new_base.upper()
            elif case == 'title':
                new_base = new_base.title()
            # show without suffix (user will see base name)
            lines.append(new_base)

        self.tc_preview.SetValue('\n'.join(lines))


class TemplateDialog(wx.Dialog):
    """Template manager dialog."""

    def __init__(self, parent, template_manager):
        super().__init__(parent, title="Template Manager", size=(500, 400))
        self.template_manager = template_manager
        self.init_ui()

    def init_ui(self):
        """Initialize template dialog UI."""
        sizer = wx.BoxSizer(wx.VERTICAL)

        # Template list
        label = wx.StaticText(self, label="Available Templates")
        self.template_list = wx.ListBox(self)
        self.refresh_templates()

        sizer.Add(label, 0, wx.ALL, 5)
        sizer.Add(self.template_list, 1, wx.EXPAND | wx.ALL, 5)

        # Buttons
        btn_sizer = wx.BoxSizer(wx.HORIZONTAL)
        btn_new = wx.Button(self, label="New Template")
        btn_delete = wx.Button(self, label="Delete")
        btn_close = wx.Button(self, wx.ID_CLOSE, "Close")

        btn_sizer.Add(btn_new, 0, wx.ALL, 5)
        btn_sizer.Add(btn_delete, 0, wx.ALL, 5)
        btn_sizer.AddStretchSpacer()
        btn_sizer.Add(btn_close, 0, wx.ALL, 5)

        sizer.Add(btn_sizer, 0, wx.EXPAND)

        self.SetSizer(sizer)

        btn_new.Bind(wx.EVT_BUTTON, self.on_new_template)
        btn_delete.Bind(wx.EVT_BUTTON, self.on_delete_template)
        btn_close.Bind(wx.EVT_BUTTON, self.on_close)

    def refresh_templates(self):
        """Refresh template list."""
        self.template_list.Clear()
        for name in self.template_manager.list_templates():
            self.template_list.Append(name)

    def on_new_template(self, event):
        """Create new template."""
        dlg = wx.TextEntryDialog(self, "Enter template name:")
        if dlg.ShowModal() == wx.ID_OK:
            name = dlg.GetValue()
            if name:
                self.template_manager.create_template(name, {}, "New template")
                self.refresh_templates()
        dlg.Destroy()

    def on_delete_template(self, event):
        """Delete selected template."""
        selection = self.template_list.GetSelection()
        if selection != wx.NOT_FOUND:
            name = self.template_list.GetString(selection)
            if wx.MessageBox(f"Delete template '{name}'?", "Confirm", wx.YES_NO | wx.ICON_QUESTION) == wx.YES:
                self.template_manager.delete_template(name)
                self.refresh_templates()

    def on_close(self, event):
        """Close dialog."""
        self.EndModal(wx.ID_CLOSE)


class App(wx.App):
    """Application class."""

    def OnInit(self):
        """Initialize the application."""
        self.frame = MainFrame()
        return True


if __name__ == '__main__':
    app = App(False)
    app.MainLoop()
